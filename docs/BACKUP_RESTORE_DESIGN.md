# 备份与恢复功能设计

## 设计理念

备份和恢复功能采用**加密数据导出/导入**的方式，而非直接操作数据库文件。这样设计的优点是：

1. **数据安全**：密码保持加密状态，只有当前账户可解密
2. **权限保护**：避免数据库文件权限问题
3. **不覆盖数据**：追加模式，不会删除现有数据
4. **格式清晰**：使用 JSON 格式，便于查看结构
5. **灵活性高**：可以选择性导入部分数据

## 加密机制

### 密码的加密方式
备份文件中的密码数据**保持加密状态**：
- 使用用户的 **Key C**（数据密钥）加密
- Key C 只有在用户登录并通过 TOTP 验证后才能获得
- 即使备份文件泄露，没有 Key C 也无法解密密码

### 安全层级
```
备份文件（JSON）
  └─ enc_data: 加密的密码数据
       └─ 加密算法: AES-256-GCM
            └─ 密钥: Key C（用户专属数据密钥）
                 └─ 获取方式: 登录 + TOTP 验证
```

## 备份功能

### 触发条件
- 用户必须已登录（需要确认用户身份）
- 在密码管理界面点击"备份数据"按钮

### 备份流程

```
1. 从数据库读取加密数据
   └─ 直接读取 enc_data（已加密的密码数据）
   
2. 构造备份数据结构
   ├─ version: 备份格式版本号
   ├─ export_at: 导出时间戳
   ├─ username: 导出用户名
   └─ items: 密码数组
       ├─ site: 网站/应用名称（明文，用于索引）
       └─ enc_data: 加密的密码数据（十六进制字符串）

3. 序列化为 JSON 格式
   └─ 使用缩进格式化，便于阅读

4. 保存为文件
   └─ 默认文件名: key-box-backup-YYYYMMDD-HHMMSS.json
```

### 备份文件格式示例

```json
{
  "version": "1.0",
  "export_at": "2026-01-31 15:30:00",
  "username": "alice",
  "items": [
    {
      "site": "github.com",
      "enc_data": "a1b2c3d4e5f6...加密数据的十六进制表示"
    },
    {
      "site": "gmail.com",
      "enc_data": "f6e5d4c3b2a1...加密数据的十六进制表示"
    }
  ]
}
```

### 安全特性

✅ **密码已加密保护**：
- 备份文件中的密码数据是密文
- 使用 AES-256-GCM 算法加密
- 只有拥有 Key C 的用户可以解密
- 需要登录并通过 TOTP 验证才能获得 Key C

⚠️ **仍需注意**：
- 网站名称是明文（用于索引）
- 备份文件暴露了你使用的网站/服务
- 建议仍要妥善保管备份文件

## 恢复功能

### 触发条件
- 用户必须已登录（需要 Key C 来解密恢复的数据）
- 在密码管理界面点击"恢复数据"按钮

### 恢复流程

```
1. 选择备份文件（JSON 格式）

2. 解析 JSON 文件
   └─ 验证格式是否正确

3. 逐条导入加密数据
   ├─ 读取每条密码记录的 enc_data
   ├─ 将十六进制字符串转为字节数组
   └─ 直接保存加密数据到数据库
   
4. 统计导入结果
   ├─ 成功导入数量
   └─ 失败数量（如有）

5. 刷新界面
   └─ 自动解密并显示新导入的数据
```

### 恢复特性

- **追加模式**：不会删除或覆盖现有数据
- **保持加密**：导入时数据仍是加密状态，显示时才解密
- **当前账户专用**：恢复的数据关联到当前登录的账户
- **批量导入**：一次可以导入多条记录

### 重要说明

⚠️ **账户绑定**：
- 备份文件中的数据使用原账户的 Key C 加密
- 恢复时会绑定到当前登录的账户
- **如果在不同账户恢复，需要该账户有相同的 Key C**
- 实际上，不同账户的 Key C 是不同的
- **因此备份文件只能在原账户中恢复**

### 错误处理

如果导入过程中出现错误：
- 已成功导入的数据会保留
- 失败的条目会在结果中显示
- 不会回滚已导入的数据

## 使用场景

### 场景 1：定期备份
```
用户登录 → 备份数据 → 保存到安全位置
建议频率：每月或每次添加重要密码后
备份文件：密码已加密，相对安全
```

### 场景 2：更换设备（同一账户）
```
旧设备：登录 → 备份数据 → 传输文件
新设备：安装应用 → 登录同一账户 → 恢复数据
注意：必须是同一账户，Key C 相同才能解密
```

### 场景 3：灾难恢复
```
情况：数据库损坏或误删
操作：登录账户 → 恢复备份 → 数据找回
前提：之前有做过备份
```

### 场景 4：不支持的场景
```
❌ 账户间迁移数据
   原因：不同账户的 Key C 不同，无法解密
   
❌ 导出明文密码
   原因：备份文件中密码是密文
   如需明文：需要在界面上逐个复制
```

## 与数据库文件备份的区别

### 旧方案（数据库文件备份）
- ❌ 覆盖整个数据库
- ❌ 可能导致权限问题
- ❌ 需要重启应用
- ❌ 依赖环境变量 SEC_APP_SALT
- ❌ 无法合并数据

### 新方案（加密数据导出/导入）
- ✅ 只操作数据，不动数据库
- ✅ 追加模式，不覆盖
- ✅ 无需重启应用
- ✅ 密码保持加密状态
- ✅ 只有原账户可解密
- ⚠️ 不支持跨账户迁移（安全考虑）

## 最佳实践

### 备份建议
1. 定期备份（建议每月一次）
2. 重要密码变更后立即备份
3. 备份文件虽然已加密，仍建议安全存储
4. 多地备份（本地 + 云盘）
5. 定期测试恢复功能

### 文件管理建议
```
backup/
├── 2026-01/
│   ├── key-box-backup-20260115-100000.json
│   └── key-box-backup-20260131-150000.json
├── 2026-02/
│   └── key-box-backup-20260228-120000.json
└── important/
    └── critical-passwords-backup.json
```

### 安全建议
1. 备份文件中密码已加密，但仍需妥善保管
2. 网站名称是明文，会暴露你使用的服务
3. 可以额外使用 GPG 或 zip 加密备份文件
   ```bash
   gpg -c key-box-backup-20260131.json
   # 或
   zip -e backup.zip key-box-backup-*.json
   ```

4. 上传到云盘前建议额外加密
5. 定期清理旧备份文件

## 注意事项

1. **密码已加密**：备份文件中密码是密文，只有原账户可解密
2. **账户绑定**：备份文件只能在原账户中恢复
3. **不支持跨账户**：不同账户的 Key C 不同，无法解密
4. **不是增量备份**：每次备份都是完整导出
5. **不会自动去重**：重复导入会产生重复记录
6. **需要登录**：备份和恢复都需要先登录账户
7. **网站名明文**：网站/应用名称是明文，会暴露使用的服务

## 技术细节

### 加密数据格式
```
enc_data 字段内容：
1. AES-256-GCM 加密的密码数据
2. 包含用户名和密码的 JSON
3. 加密密钥：用户的 Key C
4. 存储格式：十六进制字符串
```

### 数据流向

**备份流程**：
```
数据库 enc_data (bytes)
  → 转换为十六进制字符串
    → JSON 序列化
      → 写入备份文件
```

**恢复流程**：
```
备份文件
  → JSON 解析
    → 十六进制字符串转 bytes
      → 直接保存到数据库
        → 显示时用 Key C 解密
```

## 未来改进

可能的增强功能：
- [ ] 支持导出明文（用于跨账户迁移）
- [ ] 支持增量备份
- [ ] 自动定期备份
- [ ] 云同步功能
- [ ] 导入前预览（显示备份文件中的网站列表）
- [ ] 选择性导入（只导入特定网站）
- [ ] 自动去重
- [ ] 备份文件版本管理
- [ ] 备份文件压缩
