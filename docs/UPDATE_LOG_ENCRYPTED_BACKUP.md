# 更新日志 - 加密备份功能

## 2026-01-31 - 实现加密备份/恢复功能

### 核心改进

将备份功能从"明文导出"改为"密文导出"，保持密码的加密状态。

### 修改的文件

#### 1. `internal/vault/vault.go`
添加了两个新方法用于备份/恢复：

```go
// GetEncryptedItems 获取加密的密码条目（用于备份）
func (m *Manager) GetEncryptedItems(username string) ([]db.VaultItem, error)

// RestoreEncryptedItem 恢复加密的密码条目（用于恢复备份）
func (m *Manager) RestoreEncryptedItem(username, site string, encData []byte) error
```

#### 2. `cmd/gui/main.go`
重新设计备份和恢复功能：

**数据结构变更**：
```go
// 旧结构（明文）
type BackupItem struct {
    Site     string
    Username string
    Password string  // 明文密码
}

// 新结构（密文）
type BackupItemEncrypted struct {
    Site    string  // 网站名称（明文，用于索引）
    EncData string  // 加密数据（十六进制字符串）
}
```

**备份流程变更**：
- 旧：解密所有密码 → 导出明文 JSON
- 新：直接读取加密数据 → 导出密文 JSON

**恢复流程变更**：
- 旧：读取明文 → 加密 → 保存
- 新：读取密文 → 直接保存

#### 3. `docs/BACKUP_RESTORE_DESIGN.md`
完全重写文档，说明加密备份机制

### 功能特性

#### 🔐 安全性增强

1. **密码保持加密**
   - 备份文件中密码是密文
   - 使用 AES-256-GCM 算法
   - 加密密钥：用户的 Key C（数据密钥）

2. **账户绑定**
   - 备份文件只能在原账户中恢复
   - 不同账户的 Key C 不同
   - 无法跨账户迁移数据

3. **部分明文**
   - 网站/应用名称仍是明文（用于索引）
   - 会暴露用户使用的服务列表
   - 建议额外加密备份文件

#### 📦 备份功能

**操作流程**：
```
登录 → 密码管理界面 → 点击"备份数据"
  → 选择保存位置 → 导出 JSON 文件
```

**文件格式**：
```json
{
  "version": "1.0",
  "export_at": "2026-01-31 15:30:00",
  "username": "alice",
  "items": [
    {
      "site": "github.com",
      "enc_data": "a1b2c3d4...密文的十六进制表示"
    }
  ]
}
```

**特点**：
- ✅ 密码已加密
- ✅ 文件格式清晰
- ✅ 可查看网站列表
- ⚠️ 网站名称是明文

#### 📥 恢复功能

**操作流程**：
```
登录 → 密码管理界面 → 点击"恢复数据"
  → 选择备份文件 → 导入数据 → 刷新界面
```

**特点**：
- ✅ 追加模式，不覆盖现有数据
- ✅ 密码保持加密状态
- ✅ 显示导入成功/失败统计
- ✅ 自动刷新界面
- ⚠️ 只能在原账户恢复

### 使用场景

#### ✅ 支持的场景

1. **定期备份**
   - 每月备份一次
   - 重要密码变更后备份

2. **更换设备（同一账户）**
   - 旧设备：备份数据
   - 新设备：登录同一账户 → 恢复数据

3. **灾难恢复**
   - 数据库损坏
   - 误删数据

#### ❌ 不支持的场景

1. **跨账户迁移**
   - 原因：不同账户的 Key C 不同
   - 无法解密其他账户的备份

2. **导出明文密码**
   - 备份文件中密码是密文
   - 需要在界面上逐个复制

### 安全建议

#### 1. 备份文件保护
虽然密码已加密，但仍建议：
```bash
# 使用 GPG 额外加密
gpg -c key-box-backup-20260131.json

# 或使用 zip 加密
zip -e backup.zip key-box-backup-*.json
```

#### 2. 文件存储
- ✅ 本地安全位置
- ✅ 加密云盘
- ✅ 多地备份
- ❌ 不要明文存储在公共云盘
- ❌ 不要通过不安全渠道传输

#### 3. 定期维护
- 每月备份一次
- 定期测试恢复功能
- 清理过期的备份文件

### 技术细节

#### 加密机制
```
数据加密层级：
1. 用户输入明文密码
2. 使用 Key C (AES-256-GCM) 加密
3. 存储到数据库（密文）
4. 备份时直接导出密文
5. 恢复时直接导入密文
6. 显示时用 Key C 解密
```

#### 数据流向

**备份**：
```
数据库 (enc_data bytes)
  ↓
转为十六进制字符串
  ↓
JSON 序列化
  ↓
写入备份文件
```

**恢复**：
```
备份文件
  ↓
JSON 解析
  ↓
十六进制转 bytes
  ↓
保存到数据库
  ↓
显示时用 Key C 解密
```

### 与旧方案对比

| 特性 | 旧方案（数据库文件） | 中间方案（明文JSON） | 新方案（密文JSON） |
|------|---------------------|---------------------|-------------------|
| 备份内容 | 整个数据库 | 明文密码 | 密文密码 |
| 数据安全 | ⚠️ 需要保护 | ❌ 明文泄露 | ✅ 加密保护 |
| 文件权限 | ❌ 可能有问题 | ✅ 无问题 | ✅ 无问题 |
| 覆盖数据 | ❌ 全覆盖 | ✅ 追加 | ✅ 追加 |
| 跨账户迁移 | ❌ 不支持 | ✅ 支持 | ❌ 不支持（安全考虑） |
| 依赖环境变量 | ❌ 依赖 | ✅ 不依赖 | ✅ 不依赖 |
| 可读性 | ❌ 二进制 | ✅ 明文JSON | ⚠️ 部分可读 |

### 编译和测试

```bash
# 编译
cd /Users/zaneway/SynologyDrive/code-space/GolandProjects/learn/key-box
go build -o key-box-gui ./cmd/gui

# 运行
./key-box-gui

# 测试流程
1. 注册/登录账户
2. 添加几条密码
3. 点击"备份数据"导出
4. 查看备份文件（密码应该是密文）
5. 删除一条密码
6. 点击"恢复数据"导入
7. 验证数据恢复成功
```

### 待测试项目

- [ ] 备份功能正常（导出加密数据）
- [ ] 恢复功能正常（导入加密数据）
- [ ] 备份文件中密码是密文
- [ ] 恢复后数据正确显示
- [ ] 追加模式不覆盖现有数据
- [ ] 跨账户恢复失败（预期行为）
- [ ] 统计信息正确显示

### 已知限制

1. **不支持跨账户迁移**
   - 这是设计如此（安全考虑）
   - 如需跨账户，可以在未来版本添加"导出明文"功能

2. **网站名称明文**
   - 用于快速索引
   - 会暴露使用的服务列表

3. **不支持增量备份**
   - 每次都是完整备份
   - 文件可能较大

4. **不会自动去重**
   - 多次导入会产生重复记录
   - 需要手动删除

### 未来改进方向

1. 添加"导出明文"功能（用于跨账户迁移）
2. 支持增量备份
3. 自动定期备份
4. 云同步功能
5. 导入前预览
6. 选择性导入
7. 自动去重
8. 备份文件压缩

## 总结

✅ **完成的改进**：
- 密码保持加密状态
- 安全性大幅提升
- 仍支持数据备份/恢复
- 不覆盖现有数据
- 文档完善

⚠️ **需要注意**：
- 只能在原账户恢复
- 网站名称仍是明文
- 建议额外加密备份文件
