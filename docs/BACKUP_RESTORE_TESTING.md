# 备份与恢复功能测试指南

## 功能概述
本密码管理器支持完整的数据备份和恢复功能，确保用户数据安全可迁移。

## 核心设计

### 备份机制
1. **直接导出数据库**: 导出 `~/.key-box.db` 文件。
2. **Salt 值提示**: 在备份前强制显示当前 `SEC_APP_SALT` 值。
3. **用户确认**: 用户必须确认已保存 Salt 值才能继续。
4. **文件命名**: 自动生成带时间戳的文件名，便于管理多个备份。

### 恢复机制
1. **覆盖警告**: 明确提示恢复操作将覆盖当前数据。
2. **环境检查提示**: 提醒用户确保 Salt 值一致。
3. **自动备份**: 在覆盖前自动备份当前数据库。
4. **原子操作**: 恢复失败时自动回滚。

## 测试场景

### 场景 1: 正常备份流程
**前置条件**:
- 已设置 `SEC_APP_SALT=test-salt-value`
- 已登录并添加至少 2 条密码记录

**测试步骤**:
1. 登录密码库
2. 点击 "备份数据" 按钮
3. 验证弹出的对话框中显示 `SEC_APP_SALT=test-salt-value`
4. 复制 Salt 值到记事本
5. 点击 "确认并导出"
6. 选择保存位置（如桌面）
7. 验证生成的文件名格式：`key-box-backup-YYYYMMDD-HHMMSS.db`

**预期结果**:
- ✅ 对话框正确显示 Salt 值
- ✅ 文件成功保存到指定位置
- ✅ 文件大小 > 0 KB
- ✅ 显示 "备份成功" 提示

### 场景 2: 环境变量未设置时备份
**前置条件**:
- 未设置 `SEC_APP_SALT`（或设置为空）

**测试步骤**:
1. 启动应用（会自动生成临时 Salt）
2. 注册并登录
3. 点击 "备份数据"

**预期结果**:
- ✅ 显示错误提示："环境变量 SEC_APP_SALT 未设置，无法备份"
- ✅ 不进入文件选择对话框

### 场景 3: 正常恢复流程
**前置条件**:
- 有一个备份文件 `key-box-backup-xxx.db`
- 已设置与备份时相同的 `SEC_APP_SALT`

**测试步骤**:
1. 关闭应用，删除或重命名 `~/.key-box.db`
2. 设置 `export SEC_APP_SALT=test-salt-value`（与备份时一致）
3. 启动应用
4. 在登录界面点击 "恢复数据"（或通过菜单）
5. 阅读警告后点击 "确认"
6. 选择之前的备份文件
7. 验证提示 "恢复成功！请重新启动应用"
8. 重启应用并登录

**预期结果**:
- ✅ 恢复过程无报错
- ✅ 重启后能使用原账号登录
- ✅ 所有密码记录完整显示

### 场景 4: Salt 值不匹配的恢复
**前置条件**:
- 备份时的 `SEC_APP_SALT=original-salt`
- 当前设置的 `SEC_APP_SALT=wrong-salt`

**测试步骤**:
1. 使用错误的 Salt 值启动应用
2. 恢复备份文件
3. 重启应用
4. 尝试登录

**预期结果**:
- ✅ 恢复文件操作本身成功
- ❌ 登录时提示 "failed to decrypt system key (root key mismatch?)"
- 📌 这证明了 Salt 值的关键性：没有正确的 Salt，即使有备份文件也无法解密

### 场景 5: 跨设备迁移
**模拟场景**: 从 Mac 迁移到 Windows

**测试步骤**:
1. **Mac 设备**:
   - 设置 `export SEC_APP_SALT=migration-test-2026`
   - 注册账号并添加密码
   - 备份数据并记录 Salt 值
2. **Windows 设备**:
   - 设置 `$env:SEC_APP_SALT="migration-test-2026"`
   - 复制备份文件到 Windows
   - 启动应用并恢复数据
   - 重启应用
   - 使用原 OTP 登录

**预期结果**:
- ✅ 跨平台恢复成功
- ✅ 所有数据完整迁移
- ✅ OTP 验证正常工作

## 安全测试

### 测试 1: 备份文件内容检查
```bash
# 使用 SQLite 查看备份文件
sqlite3 key-box-backup-xxx.db
```
```sql
SELECT username, hex(enc_b), hex(enc_c) FROM users;
```
**验证点**:
- ✅ 所有敏感字段均为二进制数据（乱码）
- ✅ 密保问题为明文（设计如此）
- ✅ 无明文密码或答案

### 测试 2: 篡改检测
**步骤**:
1. 备份数据库
2. 使用十六进制编辑器修改备份文件中的几个字节
3. 尝试恢复

**预期结果**:
- ✅ 恢复文件操作成功
- ❌ 登录或解密数据时报错（GCM 完整性校验失败）

## 边界测试

### 测试 1: 备份文件损坏
- 备份文件被截断或部分丢失
- **预期**: 恢复时提示文件损坏或格式错误

### 测试 2: 磁盘空间不足
- 备份到磁盘空间不足的位置
- **预期**: 提示 "写入文件失败"

### 测试 3: 文件权限问题
- 备份目录无写入权限
- **预期**: 提示权限错误

## 用户操作建议

### 备份最佳实践
1. **定期备份**: 每次添加重要密码后立即备份
2. **多地备份**: 至少保留 2 个备份副本（本地 + 云盘）
3. **版本管理**: 保留最近 3 个备份版本
4. **Salt 安全**: 将 Salt 值记录在独立的安全位置

### 恢复前检查清单
- [ ] 确认 `SEC_APP_SALT` 已正确设置
- [ ] 验证备份文件完整性（文件大小正常）
- [ ] 如有重要当前数据，先进行备份
- [ ] 准备好 OTP Authenticator App
